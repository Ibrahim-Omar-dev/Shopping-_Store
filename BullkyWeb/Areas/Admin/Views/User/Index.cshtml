@{
    ViewData["Title"] = "User Management";
}

<style>
    .card-header {
        background: linear-gradient(45deg, #6c757d, #495057) !important;
    }

    .btn-action {
        min-width: 100px;
        margin: 2px;
    }

    .action-buttons {
        display: flex;
        justify-content: center;
        gap: 5px;
        flex-wrap: wrap;
    }

    /* Mobile responsive styles */
   @@media screen and (max-width: 768px) {
        .action-buttons {
            flex-direction: column;
            width: 100%;
        }

        .action-buttons .btn {
            width: 100% !important;
            margin: 2px 0;
        }

        .card-header h2 {
            font-size: 1.5rem;
        }

        .card-body {
            padding: 1rem;
        }

        .table-responsive {
            font-size: 0.875rem;
        }
    }

    @@media screen and (max-width: 576px) {
        .btn-action {
            min-width: auto;
            padding: 0.375rem 0.5rem;
        }

        .table th,
        .table td {
            padding: 0.5rem 0.25rem;
            font-size: 0.8rem;
        }

        .card-header h2 {
            font-size: 1.25rem;
        }
    }
</style>


<div class="card shadow border-0 my-4">
    <div class="card-header bg-secondary bg-gradient py-3">
        <div class="row">
            <div class="col-12 text-center">
                <h2 class="text-white py-2 mb-0">User Management</h2>
            </div>
        </div>
    </div>
    <div class="card-body p-4">
        <div class="table-responsive">
            <table id="tblData" class="table table-bordered table-striped" style="width:100%">
                <thead class="table-dark">
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Company</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

@section Scripts {
        <script src="~/js/user.js"></script>
        <script>
            var dataTable;

            $(document).ready(function () {
                loadDataTable();

                // Handle window resize
                $(window).resize(function() {
                    if (dataTable) {
                        dataTable.columns.adjust().draw();
                    }
                });
            });

            function loadDataTable() {
                dataTable = $('#tblData').DataTable({
                    responsive: true,
                    pageLength: 10,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
                    language: {
                        search: "Search users:",
                        lengthMenu: "Show _MENU_ entries per page",
                        info: "Showing _START_ to _END_ of _TOTAL_ users",
                        paginate: {
                            first: "First",
                            last: "Last",
                            next: "Next",
                            previous: "Previous"
                        }
                    },
                    "ajax": { 
                        url: '/admin/user/getall',
                        dataSrc: function(json) {
                            return json.data || json;
                        }
                    },
                    "columns": [
                        { 
                            "data": "name", 
                            "width": "15%",
                            "render": function(data, type, row) {
                                return data || 'N/A';
                            }
                        },
                        { 
                            "data": "email", 
                            "width": "20%",
                            "render": function(data, type, row) {
                                return data || 'N/A';
                            }
                        },
                        { 
                            "data": "phoneNumber", 
                            "width": "15%",
                            "render": function(data, type, row) {
                                return data || 'N/A';
                            }
                        },
                        { 
                            "data": "company.name", 
                            "width": "15%",
                            "render": function(data, type, row) {
                                return data || 'N/A';
                            }
                        },
                        { 
                            "data": "role", 
                            "width": "10%",
                            "render": function(data, type, row) {
                                return data || 'N/A';
                            }
                        },
                        {
                            data: { id: "id", lockoutEnd: "lockoutEnd" },
                            "render": function (data, type, row) {
                                var today = new Date().getTime();
                                var lockout = new Date(data.lockoutEnd).getTime();
                                var isLocked = lockout > today;

                                return `
                                    <div class="action-buttons">
                                        <button onclick="LockUnlock('${data.id}')" 
                                                class="btn ${isLocked ? 'btn-danger' : 'btn-success'} btn-sm btn-action text-white">
                                            <i class="bi ${isLocked ? 'bi-lock-fill' : 'bi-unlock-fill'}"></i> 
                                            ${isLocked ? 'Lock' : 'Unlock'}
                                        </button>
                                        <a href="/admin/user/RoleManagment?userId=${data.id}" 
                                           class="btn btn-primary btn-sm btn-action text-white">
                                            <i class="bi bi-pencil-square"></i> Permission
                                        </a>
                                    </div>
                                `;
                            },
                            "width": "25%",
                            "orderable": false
                        }
                    ],
                    order: [[0, 'asc']],
                    columnDefs: [
                        {
                            targets: -1,
                            orderable: false
                        }
                    ]
                });
            }

            function LockUnlock(id) {
                if (!id) {
                    toastr.error('Invalid user ID');
                    return;
                }

                $.ajax({
                    type: "POST",
                    url: '/Admin/User/LockUnlock',
                    data: JSON.stringify(id),
                    contentType: "application/json",
                    beforeSend: function() {
                        // Show loading indicator
                        toastr.info('Processing request...');
                    },
                    success: function (data) {
                        if (data && data.success) {
                            toastr.success(data.message || 'Operation completed successfully');
                            dataTable.ajax.reload(null, false); // Reload without resetting pagination
                        } else {
                            toastr.error(data.message || 'Operation failed');
                        }
                    },
                    error: function(xhr, status, error) {
                        toastr.error('An error occurred: ' + error);
                    }
                });
            }

            // Configure Toastr
            toastr.options = {
                "closeButton": true,
                "debug": false,
                "newestOnTop": true,
                "progressBar": true,
                "positionClass": "toast-top-right",
                "preventDuplicates": false,
                "onclick": null,
                "showDuration": "300",
                "hideDuration": "1000",
                "timeOut": "5000",
                "extendedTimeOut": "1000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
            };
        </script>
}